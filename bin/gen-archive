#!/bin/bash -e

url=$1
tag=${2:-HEAD}
case "$url" in
*.git)
  dir=$(basename "$url")
  if [[ -d "$dir" ]]; then
    cd "$dir"
    git fetch origin +master:master
  else
    git clone --bare "$url"
    cd "$dir"
  fi
  version=$(git describe --match 'v*' "$tag" | sed 's/^v//')
  name=$(basename "$dir" .git)-$version
  file=$name.tar.gz
  git archive --prefix="$name/" -o ../"$file" "$tag"
  echo "$file"
  ;;
*)
  wget -N "$url"
  echo $(basename "$url")
  ;;
esac
